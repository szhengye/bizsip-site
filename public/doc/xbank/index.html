<!DOCTYPE html><html lang="zh-Hans" >

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  
  
    <meta name="generator" content="Wowchemy 5.2.0 for Hugo" />
  

  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Nelson Bighetti" />

  
  
  
    
  
  <meta name="description" content="通过xbank项目来介绍用Biz-SIP中间件开发一个系统的全流程" />

  
  <link rel="alternate" hreflang="zh-Hans" href="http://bizsip.bizmda.com/doc/xbank/" />

  







  




  
  

  
  
  
    <meta name="theme-color" content="#1565c0" />
  

  
  

  
  
  
  
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">

    
    

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light" media="print" onload="this.media='all'">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" media="print" onload="this.media='all'" disabled>
        
      
    

    
    
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous" media="print" onload="this.media='all'">
    

    

    
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
      
      

      
      
        
      

      
    
      
      

      
      

      
    
      
      

      
      

      
    
  

  
  
  

  
  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.a53ee215eb6dcadd1a125dc8098e4c3e.css" />

  



  

  

  




  
  
  

  

  
    <link rel="manifest" href="/index.webmanifest" />
  

  <link rel="icon" type="image/png" href="/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_32x32_fill_lanczos_center_3.png" />
  <link rel="apple-touch-icon" type="image/png" href="/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_180x180_fill_lanczos_center_3.png" />

  <link rel="canonical" href="http://bizsip.bizmda.com/doc/xbank/" />

  
  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary" />
  
  <meta property="og:site_name" content="Biz-SIP服务整合中间件" />
  <meta property="og:url" content="http://bizsip.bizmda.com/doc/xbank/" />
  <meta property="og:title" content="xbank示例项目 | Biz-SIP服务整合中间件" />
  <meta property="og:description" content="通过xbank项目来介绍用Biz-SIP中间件开发一个系统的全流程" /><meta property="og:image" content="http://bizsip.bizmda.com/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_512x512_fill_lanczos_center_3.png" />
    <meta property="twitter:image" content="http://bizsip.bizmda.com/media/icon_hua2ec155b4296a9c9791d015323e16eb5_11927_512x512_fill_lanczos_center_3.png" /><meta property="og:locale" content="zh-Hans" />
  
    
      <meta
        property="article:published_time"
        content="2021-09-24T00:00:00&#43;00:00"
      />
    
    <meta property="article:modified_time" content="2021-09-24T00:00:00&#43;00:00">
  

  



  

  

  





  <title>xbank示例项目 | Biz-SIP服务整合中间件</title>
</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class="page-wrapper   " data-wc-page-id="83740526d34025b48ec117fc1c6c0474" >

  
  
  
  
  
  
  
  
  
  <script src="/js/wowchemy-init.min.c2ae95842e5b33a787c7b8c567e989a4.js"></script>

  


<aside class="search-modal" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>搜索</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#" aria-label="Close"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="搜索..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control"
        aria-label="搜索...">
        
      </div>

      
      

      

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>



  <div class="page-header">
    












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container-xl">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Biz-SIP服务整合中间件</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar-content" aria-expanded="false" aria-label="切换导航">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Biz-SIP服务整合中间件</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-end" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/doc"><span>指南</span></a>
        </li>

        
        

        

        
        
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/post"><span>博客</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/event"><span>更新日志</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">

      
      
        
      

      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="搜索"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      

      
      

    </ul>

  </div>
</nav>


  </div>

  <div class="page-body">
    





<div class="container-fluid docs">
  <div class="row flex-xl-nowrap">
    <div class="col-12 col-md-3 col-xl-2 docs-sidebar">
      <form class="docs-search d-flex align-items-center">
  <button class="btn docs-toggle d-md-none p-0 mr-md-3 w-100" type="button" data-toggle="collapse" data-target="#docs-nav" aria-controls="docs-nav" aria-expanded="false" aria-label="Toggle section navigation">
    <div class="d-flex">
      <span class="d-md-none pl-1 flex-grow-1 text-left overflow-hidden">
        
          Biz-SIP文档
        
      </span>
      <span><i class="fas fa-chevron-down"></i></span>
    </div>
  </button>

  
  <button class="form-control sidebar-search js-search d-none d-md-flex">
    <i class="fas fa-search pr-2"></i>
    <span class="sidebar-search-text">搜索...</span>
    <span class="sidebar-search-shortcut">/</span>
  </button>
  
</form>

<nav class="collapse docs-links" id="docs-nav">
  
  
  
  
  
  

  
  
    

    
      

      


  
    
    
    
    
      
    
    

    
      <ul class="nav docs-sidenav">
        <li class=""><a href="/doc/">Biz-SIP文档</a></li>
    
      


  <li class=""><a href="/doc/quick-start/">快速启动</a></li>



  <li class=""><a href="/doc/configuation/">系统配置</a></li>



  <li class=""><a href="/doc/development/">系统开发</a></li>



  <li class=""><a href="/doc/interface/">接口规范</a></li>



  <li class=""><a href="/doc/know-how/">运行原理</a></li>



  <li class=""><a href="/doc/extend/">扩展开发</a></li>



  <li class="active"><a href="/doc/xbank/">xbank示例项目</a></li>

      
    

    
      </ul>
    

  
</nav>

    </div>

    
    
    <div class="d-none d-xl-block col-xl-2 docs-toc">
      

      <ul class="nav toc-top">
        <li><a href="#" id="back_to_top" class="docs-toc-title">在本页</a></li>
      </ul>

      <nav id="TableOfContents">
  <ul>
    <li><a href="#一biz-sip架构和ddd领域驱动设计入门介绍">一、Biz-SIP架构和DDD领域驱动设计入门介绍</a>
      <ul>
        <li><a href="#1-ddd领域驱动设计">1. DDD领域驱动设计</a></li>
        <li><a href="#2-cola架构">2. COLA架构</a></li>
      </ul>
    </li>
    <li><a href="#二体验biz-sip示例项目xbank">二、体验Biz-SIP示例项目xbank</a>
      <ul>
        <li><a href="#1-示例项目xbank简介">1. 示例项目xbank简介</a></li>
        <li><a href="#3-xbank示例项目模板介绍">3. xbank示例项目模板介绍</a></li>
        <li><a href="#4-创建数据库">4. 创建数据库</a></li>
        <li><a href="#5-启动xbank项目">5. 启动xbank项目</a></li>
        <li><a href="#4-测试接口">4. 测试接口</a></li>
        <li><a href="#heading"></a></li>
      </ul>
    </li>
    <li><a href="#三项目实践客户域服务的开发">三、项目实践：客户域服务的开发</a>
      <ul>
        <li><a href="#1-创建数据库">1. 创建数据库</a></li>
        <li><a href="#2-自动生成数据访问层代码">2. 自动生成数据访问层代码</a></li>
        <li><a href="#3-customer领域服务接口和实现类的开发">3. Customer领域服务接口和实现类的开发</a></li>
        <li><a href="#4-customer领域服务的快速发布">4. Customer领域服务的快速发布</a></li>
        <li><a href="#5-customer领域服务在应用层和适配层的定制">5. Customer领域服务在应用层和适配层的定制</a></li>
      </ul>
    </li>
    <li><a href="#四项目实践账户域服务的开发">四、项目实践：账户域服务的开发</a>
      <ul>
        <li><a href="#1-account领域服务的封装">1. Account领域服务的封装</a></li>
        <li><a href="#2-account服务在适配层和应用层的开发和对外暴露">2. Account服务在适配层和应用层的开发和对外暴露</a></li>
      </ul>
    </li>
    <li><a href="#五项目实践客户域和账户域服务在应用层的编排">五、项目实践：客户域和账户域服务在应用层的编排</a></li>
    <li><a href="#六项目实践支付域服务的开发">六、项目实践：支付域服务的开发</a>
      <ul>
        <li><a href="#1-payment领域服务的封装">1. Payment领域服务的封装</a></li>
        <li><a href="#2-payment服务的快速发布">2. Payment服务的快速发布</a></li>
        <li><a href="#3-payment领域服务在应用层和适配层的定制">3. payment领域服务在应用层和适配层的定制</a></li>
      </ul>
    </li>
    <li><a href="#七项目实践应用服务对延迟服务的组装">七、项目实践：应用服务对延迟服务的组装</a>
      <ul>
        <li><a href="#1-saf存储转发的实现">1. SAF存储转发的实现</a></li>
        <li><a href="#2-向前补偿的实现">2. 向前补偿的实现</a></li>
        <li><a href="#3-向后补偿的实现">3. 向后补偿的实现</a></li>
      </ul>
    </li>
    <li><a href="#八总结">八、总结</a>
      <ul>
        <li><a href="#1-sink服务领域层服务">1. Sink服务（领域层服务）</a></li>
        <li><a href="#2-biz-service聚合服务应用层服务">2. Biz-Service聚合服务（应用层服务）</a></li>
        <li><a href="#3-适配层服务">3. 适配层服务</a></li>
      </ul>
    </li>
    <li><a href="#附录1biz-sip运行机制图">附录1：Biz-SIP运行机制图</a></li>
    <li><a href="#附录2ddd各层功能定位与粒度划分">附录2：DDD各层功能定位与粒度划分</a></li>
  </ul>
</nav>

      
    </div>
    

    <main class="col-12 col-md-9 col-xl-8 py-md-3 pl-md-5 docs-content" role="main">

      <article class="article">

        <div class="docs-article-container">
          

          <h1>xbank示例项目</h1>

          <div class="article-style">
            <p>通过xbank项目来介绍用Biz-SIP中间件开发一个系统的全流程</p>
<p><strong>xbank项目版本库：</strong><a href="https://gitee.com/szhengye/xbank.git" target="_blank" rel="noopener"><strong>https://gitee.com/szhengye/xbank.git</strong></a></p>
<h2 id="一biz-sip架构和ddd领域驱动设计入门介绍">一、Biz-SIP架构和DDD领域驱动设计入门介绍</h2>
<h3 id="1-ddd领域驱动设计">1. DDD领域驱动设计</h3>
<p>2004年，Eric Evans完成了《Domain-Driven Design Tackling Complexity in the Heart of Software》一书，提出了一套针对业务领域建模的方法论和思想&ndash;领域驱动设计，简称DDD。
领域驱动设计（DDD）是一种基于模型驱动的软件设计方式。它以领域为核心，分析领域中的问题，通过建立一个领域模型来有效地解决领域中的核心、复杂问题。
领域驱动设计提出了一套核心构造块（Building Blocks），如聚合、实体、值对象、领域服务、领域工厂、仓储、领域事件等。这些构造块是对面向对象领域建模的一些核心最佳实践的浓缩。这些构造块可以使得我们的设计更加标准、有序。
利用 DDD 提倡的分层、六边形等架构，分离了业务复杂度和技术复杂度，使得系统具备更强的扩展性和弹性；战术层面提供了元模型（聚合，实体，值对象，服务，工厂，仓储等等）帮助构建清晰、稳定，能快速响应变化和新需求能力的应用。</p>
<h3 id="2-cola架构">2. COLA架构</h3>
<p>COLA 4.0 推荐的应用架构如下图所示：
<img src="1630415427800-07efac34-8cd6-4df1-82d2-d19af10c513c.png" alt="image.png">
1）适配层（Adapter Layer）：负责对前端展示（web，wireless，wap）的路由和适配，对于传统B/S系统而言，adapter就相当于MVC中的controller；
2）应用层（Application Layer）：主要负责获取输入，组装上下文，参数校验，调用领域层做业务处理，如果需要的话，发送消息通知等。层次是开放的，应用层也可以绕过领域层，直接访问基础实施层；
3）领域层（Domain Layer）：主要是封装了核心业务逻辑，并通过领域服务（Domain Service）和领域对象（Domain Entity）的方法对App层提供业务实体和业务逻辑计算。领域是应用的核心，不依赖任何其他层次；
4）基础设施层（Infrastructure Layer)：主要负责技术细节问题的处理，比如数据库的CRUD、搜索引擎、文件系统、分布式服务的RPC等。此外，领域防腐的重任也落在这里，外部依赖需要通过gateway的转义处理，才能被上面的App层和Domain层使用。</p>
<hr>
<h2 id="二体验biz-sip示例项目xbank">二、体验Biz-SIP示例项目xbank</h2>
<h3 id="1-示例项目xbank简介">1. 示例项目xbank简介</h3>
<p>xbank是一家商业银行，面向个人客户和公司客户，其中个人客户业务包括存款、贷款、缴费等业务；银行业务渠道除了传统柜面以外，还有网上银行、手机银行、ATM、POS等，最近准备上一个针对银行合作伙伴的基于OPENAPI网关的开放平台渠道。
本示例项目是以个人客户中的存款查询和缴费业务为例子，渠道采用OPENAPI开放接口，后台系统对接个人客户存款系统和个人客户信息系统，第三方对接缴费平台，来演示如何打造基于Biz-SIP中间件的银行业务中台。
<img src="1630736586701-bb5dd0f9-f227-46c9-811f-8aa91d2e5ec4.png" alt="image.png"></p>
<p>按DDD分层架构，应用架构图如下所示：
<img src="1631769310897-aa802b0c-0946-4bae-802c-525ff8d5d667.png" alt="image.png"></p>
<h3 id="3-xbank示例项目模板介绍">3. xbank示例项目模板介绍</h3>
<p>打开示例项目，如下图：
<img src="1631770657971-e46b2907-ad55-40cf-a17c-4fc559de6440.png" alt="image.png">
xbank项目分为以下模块：</p>
<ul>
<li>xbank-source：适配层模块，存放外部适配接入的适配层实现。
<ul>
<li>xbank-openapi-source：OPENAPI接入的适配层子模块</li>
</ul>
</li>
<li>xbank-app：应用层模块，存放应用层的服务实现。</li>
<li>xbank-sink：领域层模块，存放按领域划分的领域服务实现。
<ul>
<li>xbank-account-sink：账户域子模块</li>
<li>xbank-customer-sink：客户域子模块</li>
<li>xbank-payment1-sink：缴费域子模块（存储转发）</li>
<li>xbank-payment1-sink：缴费域子模块（交易补偿）</li>
</ul>
</li>
<li>xbank-infrastructure：基础设施层模块，存放对数据库、内容存储、HSM等基础设施的访问能力实现。
<ul>
<li>xbank-account-db：账户数据库访问子模块</li>
<li>xbank-customre-db：客户数据库访问子模块</li>
</ul>
</li>
<li>xbank-client：接口模块，存放各层之间的服务接口，以及相关数据DTO。
<ul>
<li>xbank-account-sink-client：账户域服务接口子模块</li>
<li>xbank-customer-sink-client：客户域服务接口子模块</li>
<li>xbank-app-client：应用服务接口子模块</li>
</ul>
</li>
</ul>
<h3 id="4-创建数据库">4. 创建数据库</h3>
<p>执行项目中xbank-infrastructure/xbank-sql/xbank.sql脚本，以建立xbank演示库。</p>
<h3 id="5-启动xbank项目">5. 启动xbank项目</h3>
<ul>
<li>启动应用层服务整合器
<ul>
<li>执行xbank-app模块中的XbankAppApplication</li>
</ul>
</li>
<li>启动领域层领域服务
<ul>
<li>执行xbank-customer-sink子模块中的CustomerSinkApplication</li>
<li>执行xbank-account-sink子模块中的AccountSinkAppliction</li>
</ul>
</li>
<li>启动适配层OPENAPI接入服务
<ul>
<li>执行xbank-openapi-source子模块中的OpenapiSourceApplication</li>
</ul>
</li>
</ul>
<h3 id="4-测试接口">4. 测试接口</h3>
<h4 id="41-查询客户信息">4.1 查询客户信息</h4>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:sink/customer&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomer&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq              
{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;2d3ed69623f8480a9d95bcd3ca03a4d3&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630677591308,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;sex&quot;: &quot;1&quot;,
      &quot;customerName&quot;: &quot;张三&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;age&quot;: 30
    }
  }
}
</code></pre>
<h4 id="42-查询账户列表">4.2 查询账户列表</h4>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:sink/account&quot; -X POST --data '{&quot;methodName&quot;:&quot;getAccountListByCustomerId&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;748b76566a5e436e9c2990cf9776789f&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630677747532,
  &quot;data&quot;: {
    &quot;result&quot;: [
      {
        &quot;accountId&quot;: &quot;0001&quot;,
        &quot;balance&quot;: 100,
        &quot;customerId&quot;: &quot;001&quot;
      },
      {
        &quot;accountId&quot;: &quot;0002&quot;,
        &quot;balance&quot;: 200,
        &quot;customerId&quot;: &quot;001&quot;
      }
    ]
  }
}

</code></pre>
<h4 id="43-查询客户信息和账户列表">4.3 查询客户信息和账户列表</h4>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomerAndAccountList&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;4fa2f86c23ce4b24abb1b0d23833c14f&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630677780246,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;accountList&quot;: [
        {
          &quot;accountId&quot;: &quot;0001&quot;,
          &quot;balance&quot;: 100,
          &quot;customerId&quot;: &quot;001&quot;
        },
        {
          &quot;accountId&quot;: &quot;0002&quot;,
          &quot;balance&quot;: 200,
          &quot;customerId&quot;: &quot;001&quot;
        }
      ],
      &quot;customer&quot;: {
        &quot;sex&quot;: &quot;1&quot;,
        &quot;customerName&quot;: &quot;张三&quot;,
        &quot;customerId&quot;: &quot;001&quot;,
        &quot;age&quot;: 30
      }
    }
  }
}
</code></pre>
<h3 id="heading"></h3>
<h2 id="三项目实践客户域服务的开发">三、项目实践：客户域服务的开发</h2>
<h3 id="1-创建数据库">1. 创建数据库</h3>
<p>执行项目中xbank-infrastructure/xbank-sql/xbank.sql脚本，以建立xbank演示库。</p>
<h3 id="2-自动生成数据访问层代码">2. 自动生成数据访问层代码</h3>
<p>数据库创建后，用MybatisX插件自动生成数据访问层代码：
<img src="1630738820784-7473f0a7-7ac5-4738-8a3e-68b5e128366d.png" alt="image.png"></p>
<h3 id="3-customer领域服务接口和实现类的开发">3. Customer领域服务接口和实现类的开发</h3>
<p>先在xbank-customer-domain-client子模块中约定customer领域服务接口，这个接口是共享给领域层和应用层的：
<img src="1631770763773-37715fd7-dd91-4faf-aab8-08fc5b98bd1d.png" alt="image.png">
然后在xbank-customer-sink子模块中完成以下工作：</p>
<ol>
<li>基于此接口完成CustomerSinkService类的编写；</li>
<li>完成CustomerSinkApplication启动类的编写；</li>
<li>配置application.yml相关文件。</li>
</ol>
<p><img src="1631769805722-f5fcc556-00c8-421c-85f3-ed62706f3870.png" alt="image.png">
以上就完成了客户领域服务微服务的开发，接下来需要把这个客户领域服务微服务，通过sink接入Biz-SIP平台，配置xbank-app/config/sink.yml，就把CustomerSinkService类挂接到了sink（customer-sink)上：
<img src="1631769899833-9983d1d9-936c-44b7-86d8-f98a9ee9e96d.png" alt="image.png"></p>
<h3 id="4-customer领域服务的快速发布">4. Customer领域服务的快速发布</h3>
<p>Customer领域服务接入Biz-SIP平台后，能实现在Biz-SIP开放平台接口的快速发布，这需要在xbank-app/config/service.yml中配置一个类型为“sink-service”的聚合服务：
<img src="1631770202721-005d08b1-92a5-4855-873b-e5ecd96c0802.png" alt="image.png">
注：这类“sink-service”的聚合服务，命名规范为“sink/xxx”，xxx为sink名称。
启动Biz-SIP平台和Customer领域服务，就可以直接在Biz-SIP开放平台接口进行访问：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:sink/customer&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomer&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;e763a42f9a2a49518c2bc6c157d08bab&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630740781540,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;sex&quot;: &quot;1&quot;,
      &quot;customerName&quot;: &quot;张三&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;age&quot;: 30
    }
  }
}
</code></pre>
<p>在上传的数据体中，“methodName”为方法名，“params”为输入参数。</p>
<h3 id="5-customer领域服务在应用层和适配层的定制">5. Customer领域服务在应用层和适配层的定制</h3>
<p>通过在service.yml中配置sink-service聚合服务，能实现已经挂接到Sink的领域服务的快速发布；但是，客户针对应用层和适配层，还是有个性化定制要求，这就涉及到应用层和适配层的定制。
同样以已经挂接到customer-sink上的Customer领域服务为例，先在xbank-app-client子模块中约定应用层接口，这个接口是共享给应用层和适配层的：
<img src="1631784835222-e08c9e4d-4a53-4af3-b2a0-76ab3a1ec1ca.png" alt="image.png">
然后在xbank-app模块中基于此接口完成PersonalAppService类的编写：
<img src="1631770955734-46595cd1-5d39-4a62-9549-f69f3fbc6fa3.png" alt="image.png">
在xbank-app/config/service.yml中配置一个类型为“bean-service”的聚合服务，并类名指定为上面实现的PersonalAppService应用层服务类：
<img src="1631771374770-e4f66443-70d6-419e-958c-86009f30f6ff.png" alt="image.png">
最后在适配层中，定制一个controller来对外发布服务：
<img src="1631771757331-ffa6ca09-dffa-4faa-92e5-7e2d31d395af.png" alt="image.png">
开发者可以在适配层的controller类中通过personalAppInterface，直接调用应用层的PersonalAppService服务：</p>
<pre><code class="language-bash">$ curl http://localhost:9001/personal/getCustomer\?customerId=001|jq

{
  &quot;customerId&quot;: &quot;001&quot;,
  &quot;customerName&quot;: &quot;张三&quot;,
  &quot;age&quot;: 30,
  &quot;sex&quot;: &quot;1&quot;
}

</code></pre>
<h2 id="四项目实践账户域服务的开发">四、项目实践：账户域服务的开发</h2>
<h3 id="1-account领域服务的封装">1. Account领域服务的封装</h3>
<p>Account领域服务是和Customer领域服务并列的，Account领域服务的封装，依次有以下步骤：</p>
<ul>
<li>第1步：领域服务接口的约定：在xbank-account-sink-client中编写AccountSinkInterface接口；</li>
<li>第2步：领域服务的实现：创建xbank-account-sink子模块，基于第1步约定的接口，实现AccountSinkService SpringBean，并封装成能独立运行的微服务应用；</li>
<li>第3步：配置sink.yml文件，把AccountSinkService SpringBean作为Sink连接到Biz-SIP平台；</li>
</ul>
<p>另外，Account领域服务在封装时，涉及到多个接口调用，对每个接口采用命令执行器（Command Executor），所有的接口实现继承AbstractBeanCmdExe类来实现：
<img src="1631772314042-262db11c-3554-47c5-b1da-2bfed319f37d.png" alt="image.png"></p>
<h3 id="2-account服务在适配层和应用层的开发和对外暴露">2. Account服务在适配层和应用层的开发和对外暴露</h3>
<p>把sink服务，暴露给适配层接口调用，有2种方案：</p>
<blockquote>
<p>方案一：</p>
</blockquote>
<p>通过sink-service类型，打通适配层和应用层：直接把account领域服务所对应的sink，直接暴露给Biz-SIP开放平台接口。</p>
<ul>
<li>第4步：配置service.yml文件，把account-sink直接作为sink-service暴露给Biz-SIP开放平台接口。</li>
</ul>
<p>接口测试如下：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:sink/account&quot; -X POST --data '{&quot;methodName&quot;:&quot;getAccountListByCustomerId&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;2280472dd72c4ee4a2b7214604e9cf27&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630751382623,
  &quot;data&quot;: {
    &quot;result&quot;: [
      {
        &quot;accountId&quot;: &quot;0001&quot;,
        &quot;balance&quot;: 100,
        &quot;customerId&quot;: &quot;001&quot;
      },
      {
        &quot;accountId&quot;: &quot;0002&quot;,
        &quot;balance&quot;: 200,
        &quot;customerId&quot;: &quot;001&quot;
      }
    ]
  }
}

</code></pre>
<blockquote>
<p>方案二：</p>
</blockquote>
<p>通过bean-service，打通适配层和应用层：</p>
<ul>
<li>第4步：应用服务接口的约定：在xbank-personal-app-client中编写PersonalAppInterface接口和CustomerAndAccountList DTO类；</li>
<li>第5步：应用服务的实现：在xbank-app模块中，基于第4步约定的接口实现PersonalAppService服务；</li>
<li>第6步：配置service.yml文件，把第5步开发PersonalAppService服务，通过bean-service的account-sink暴露给适配层；</li>
<li>第7步：在适配层创建xbank-openapi-source子模块，开发PersonalController类，暴露个性化的REST接口，并通过SourceClientFactory.getBizServiceClient(PersonalAppInterface.class,&ldquo;app/personal&rdquo;)获取应用层服务的调用接口（具体请参见<a href="#lazZY">链接</a>），在适配层中调用应用层约定接口。</li>
</ul>
<p>接口测试如下：</p>
<pre><code class="language-bash">$ curl http://localhost:9001/personal/getAccountListByCustomerId\?customerId=001|jq

[
  {
    &quot;accountId&quot;: &quot;0001&quot;,
    &quot;balance&quot;: 100,
    &quot;customerId&quot;: &quot;001&quot;
  },
  {
    &quot;accountId&quot;: &quot;0002&quot;,
    &quot;balance&quot;: 200,
    &quot;customerId&quot;: &quot;001&quot;
  }
]

</code></pre>
<h2 id="五项目实践客户域和账户域服务在应用层的编排">五、项目实践：客户域和账户域服务在应用层的编排</h2>
<p>上面已经分别实现了客户域和账户域服务的开发和部署，在应用层中，能方便地对域服务进行服务编排。
在xbank-app模块中，我们可以在PersonalAppService类中，方便地进行服务编排，代码如下：</p>
<pre><code class="language-java">@Service
public class PersonalAppService implements PersonalAppInterface {
    private AccountSinkInterface accountSinkInterface = IntegratorClientFactory
            .getSinkClient(AccountSinkInterface.class,&quot;account-sink&quot;);
    private CustomerSinkInterface customerSinkInterface = IntegratorClientFactory
            .getSinkClient(CustomerSinkInterface.class,&quot;customer-sink&quot;);
    private BizMessageInterface payment1SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment1-sink&quot;);
    private BizMessageInterface payment2SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment2-sink&quot;);
    private PersonalAppInterface personalAppDelayInterface = IntegratorClientFactory
            .getDelayBizServiceClient(PersonalAppInterface.class,&quot;app/personal&quot;,
                    0,1000,2000,4000,8000,16000,32000);

    @Override
    public CustomerAndAccountList getCustomerAndAccountList(String customerId) {
        Customer customer = this.customerSinkInterface.getCustomer(customerId);
        List&lt;Account&gt; accountList = this.accountSinkInterface.getAccountListByCustomerId(customerId);
        CustomerAndAccountList customerAndAccountList = new CustomerAndAccountList();
        customerAndAccountList.setCustomer(customer);
        customerAndAccountList.setAccountList(accountList);
        return customerAndAccountList;
    }
...
}
</code></pre>
<p>在getCustomerAndAccountList()方法中，我们可以同时调用客户域的接口customerSinkInterface，也可以调用账户域的接口accountSinkInterface，从而实现多个域服务的混合编排。
这个聚合服务通过bean-service进行部署：
<img src="1631777560691-21eeb1ae-c10f-4491-b80d-3a48132b2653.png" alt="image.png">
，分别支持Biz-SIP开放平台接口访问和个性化的PersonController实现的REST接口：</p>
<ul>
<li>通过Biz-SIP开放平台接口测试：</li>
</ul>
<pre><code class="language-java">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomerAndAccountList&quot;,&quot;params&quot;:[&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;c3cda0e1b95f449e986dc5ee41e48716&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1630760469452,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;accountList&quot;: [
        {
          &quot;accountId&quot;: &quot;0001&quot;,
          &quot;balance&quot;: 100,
          &quot;customerId&quot;: &quot;001&quot;
        },
        {
          &quot;accountId&quot;: &quot;0002&quot;,
          &quot;balance&quot;: 200,
          &quot;customerId&quot;: &quot;001&quot;
        }
      ],
      &quot;customer&quot;: {
        &quot;sex&quot;: &quot;1&quot;,
        &quot;customerName&quot;: &quot;张三&quot;,
        &quot;customerId&quot;: &quot;001&quot;,
        &quot;age&quot;: 30
      }
    }
  }
}
</code></pre>
<ul>
<li>通过个性化PersonController实现的REST接口，接口测试如下：</li>
</ul>
<pre><code class="language-java">$ curl http://localhost:9001/personal/getCustomerAndAccountList\?customerId=001|jq

{
  &quot;customer&quot;: {
    &quot;customerId&quot;: &quot;001&quot;,
    &quot;customerName&quot;: &quot;张三&quot;,
    &quot;age&quot;: 30,
    &quot;sex&quot;: &quot;1&quot;
  },
  &quot;accountList&quot;: [
    {
      &quot;accountId&quot;: &quot;0001&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;balance&quot;: 100
    },
    {
      &quot;accountId&quot;: &quot;0002&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;balance&quot;: 200
    }
  ]
}

</code></pre>
<h2 id="六项目实践支付域服务的开发">六、项目实践：支付域服务的开发</h2>
<h3 id="1-payment领域服务的封装">1. Payment领域服务的封装</h3>
<p>payment领域服务是对接第三方缴费平台的，第三方缴费平台的接口是XML报文格式。
payment领域服务是属于对接第三方的领域服务，前面提到的customer领域服务和account领域服务，主要是内部交易处理的领域服务。
这二类领域服务在开发时有比较大的不同：</p>
<ul>
<li>对接第三方的领域服务，一般涉及到复杂的通讯接口对接和报文格式转换；</li>
<li>内部交易处理领域服务，应用层和领域层之间，建议采用约定的Interface接口类的调用约定（底层Biz-SIP平台自动转换成RESTful协议和BizMessage标准消息进行交互）。</li>
</ul>
<p>在开发对接第三方的领域服务时，建议采用实现SinkBeanInterface接口的JavaBean或SpringBean：</p>
<pre><code class="language-java">public interface SinkBeanInterface {
    /**
     * Java服务调用接口
     * @param beforeJsonObject 打包前的JsonObject
     * @param packMessage 传入的消息
     * @return 返回值
     * @throws BizException
     */
    public byte[] process(JSONObject beforeJsonObject, byte[] packMessage) throws BizException;
}
</code></pre>
<p>在process()方法中传入的beforeJsonObject参数，是传入sink但还没经过打包的JSONObject对象，packMessage参数已经根据sink的消息格式配置，完成了对于目标消息格式的转换。
​</p>
<p>Payment领域服务的封装，依次有以下步骤：</p>
<blockquote>
<p>第1步</p>
</blockquote>
<p>领域服务的实现：创建xbank-payment1-sink子模块，根据SinkBeanInterface接口，实现Payment1SinkService微服务，并封装成能独立运行的微服务应用：</p>
<pre><code class="language-java">@Service
public class Payment1SinkService implements SinkBeanInterface {
    @Override
    public byte[] process(JSONObject beforeJsonObject, byte[] inMessage) throws BizException {
        log.info(&quot;传入消息:\n{}&quot;, BizUtils.buildHexLog(inMessage));
        return inMessage;
    }
}
</code></pre>
<blockquote>
<p>第2步</p>
</blockquote>
<p>在sink.yml文件中，把Payment1SinkService微服务作为Sink连接到Biz-SIP平台：</p>
<pre><code class="language-yaml">- id: payment1-sink
  type: rest
  url: http://payment1-sink/sink
  converter:
    type: simple-xml
  connector:
    type: sink-bean
    class-name: com.xbank.sink.payment.service.Payment1SinkService
    spring-bean: true
</code></pre>
<h3 id="2-payment服务的快速发布">2. Payment服务的快速发布</h3>
<p>配置service.yml文件，把payment-sink直接作为sink-service暴露给Biz-SIP开放平台接口：</p>
<pre><code class="language-yaml">- bizServiceId: sink/payment1
  type: sink-service
  sinkId: payment1-sink
</code></pre>
<p>接口测试如下：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:sink/payment1&quot; -X POST --data '{&quot;message&quot;:&quot;Hello world!&quot;}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;af37bbbb495744d79f2f1811178436f5&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631153112943,
  &quot;data&quot;: {
    &quot;message&quot;: &quot;Hello world!&quot;
  }
}

</code></pre>
<p>Payment1SinkApplication会打印出日志，收到了完成消息转换后的XML报文：</p>
<pre><code>2021-09-09 10:05:13.265  INFO 10756 --- [nio-8003-exec-1] c.x.d.p.service.Payment1DomainService    : 传入消息:
====+ 01-02-03-04-05-06-07-08-09-10-11-12-13-14-15-16-17-18-19-20 + ====== ASCII  ====== +
0000: 3C 3F 78 6D 6C 20 76 65 72 73 69 6F 6E 3D 22 31 2E 30 22 20 | &lt;?xml version=&quot;1.0&quot;  |
0020: 65 6E 63 6F 64 69 6E 67 3D 22 55 54 46 2D 38 22 20 73 74 61 | encoding=&quot;UTF-8&quot; sta |
0040: 6E 64 61 6C 6F 6E 65 3D 22 6E 6F 22 3F 3E 3C 72 6F 6F 74 3E | ndalone=&quot;no&quot;?&gt;&lt;root&gt; |
0060: 3C 6D 65 73 73 61 67 65 3E 48 65 6C 6C 6F 20 77 6F 72 6C 64 | &lt;message&gt;Hello world |
0080: 21 3C 2F 6D 65 73 73 61 67 65 3E 3C 2F 72 6F 6F 74 3E       | !&lt;/message&gt;&lt;/root&gt;.. |
</code></pre>
<h3 id="3-payment领域服务在应用层和适配层的定制">3. payment领域服务在应用层和适配层的定制</h3>
<p>通过在service.yml中配置sink-service聚合服务，能实现已经挂接到Sink的领域服务的快速发布。
但是，客户针对应用层和适配层，还是有个性化定制要求，这就涉及到应用层和适配层的定制。
例如我们要实现一个把消息发送给缴费平台的业务，输入的消息包括：交易码、传递的消息。
首先，需要在xbank-personal-app-client子模块中的PersonalAppInterface接口，增加一个消息发送接口send2payment1()，这个接口是共享给应用层和适配层的：</p>
<pre><code class="language-java">public interface PersonalAppInterface {
    ...
    public BizMessage send2Payment1(Object message) throws BizException;
    ...
}
</code></pre>
<p>然后在xbank-app模块中基于此接口方法。在PersonalAppService类实现接口：</p>
<pre><code class="language-java">public class PersonalAppService implements PersonalAppInterface {
	...
    private BizMessageInterface payment1DomainInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment1-sink&quot;);
	...
    @Override
    public BizMessage&lt;JSONObject&gt; send2Payment1(Object message) throws BizException {
        JSONObject jsonObject = new JSONObject();
        jsonObject.set(&quot;message&quot;,message);
        return this.payment1DomainInterface.call(jsonObject);
    }
    ...
}
</code></pre>
<p>由于payment领域服务没有另外约定接口，是采用BizMessage标准消息接口，所以是采用BizMessageInterface接口来构建sink调用接口的，并统一通过call()方法来调用领域服务。
由于前面已经在service.yml中把PersonalAppService应用层服务类，配置成了“bean-service”的聚合服务，所以可以直接进行接口调用：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;send2Payment1&quot;,&quot;params&quot;:[&quot;Hello world!&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;19620fe5843d4d53a2bf1f599b516006&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631153624870,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;traceId&quot;: &quot;19620fe5843d4d53a2bf1f599b516006&quot;,
      &quot;code&quot;: 0,
      &quot;data&quot;: {
        &quot;message&quot;: &quot;Hello world!&quot;
      },
      &quot;message&quot;: &quot;success&quot;,
      &quot;timestamp&quot;: 1631153624870
    }
  }
}
</code></pre>
<p>Payment1SinkApplication应用会收到消息：</p>
<pre><code>2021-09-09 10:13:44.911  INFO 10756 --- [nio-8003-exec-2] c.x.d.p.service.Payment1DomainService    : 传入消息:
====+ 01-02-03-04-05-06-07-08-09-10-11-12-13-14-15-16-17-18-19-20 + ====== ASCII  ====== +
0000: 3C 3F 78 6D 6C 20 76 65 72 73 69 6F 6E 3D 22 31 2E 30 22 20 | &lt;?xml version=&quot;1.0&quot;  |
0020: 65 6E 63 6F 64 69 6E 67 3D 22 55 54 46 2D 38 22 20 73 74 61 | encoding=&quot;UTF-8&quot; sta |
0040: 6E 64 61 6C 6F 6E 65 3D 22 6E 6F 22 3F 3E 3C 72 6F 6F 74 3E | ndalone=&quot;no&quot;?&gt;&lt;root&gt; |
0060: 3C 6D 65 73 73 61 67 65 3E 48 65 6C 6C 6F 20 77 6F 72 6C 64 | &lt;message&gt;Hello world |
0080: 21 3C 2F 6D 65 73 73 61 67 65 3E 3C 2F 72 6F 6F 74 3E       | !&lt;/message&gt;&lt;/root&gt;.. |
</code></pre>
<p>在适配层中，在原有的PersonalController类中，增加对“/send2Payment1&quot;请求的实现：</p>
<pre><code class="language-java">    @GetMapping(value =&quot;/send2Payment1&quot;)
    public BizMessage&lt;JSONObject&gt; send2Payment1(String message) throws BizException {
        return this.personalAppInterface.send2Payment1(message);
    }
</code></pre>
<p>开发者可以在适配层的PersonalController类中，通过personalAppInterface，把消息发送给缴费平台：</p>
<pre><code class="language-bash">$ curl http://localhost:9001/personal/send2Payment1\?message=hello|jq 

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;3c9d800b3c76480c9ae605d543709ea3&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631154087879,
  &quot;data&quot;: {
    &quot;message&quot;: &quot;hello&quot;
  }
}
</code></pre>
<p>在适配层中，还可以通过配置sink-service类型的聚合服务，直接调用领域层的Sink服务。例如可以在原有的PersonalController类中，直接向应用层发起JSONObject类型的平台报文：</p>
<pre><code class="language-java">@RestController
@RequestMapping(&quot;/personal&quot;)
public class PersonalController  {
	...
    private BizMessageInterface payment1SinkInterface = SourceClientFactory
            .getBizServiceClient(BizMessageInterface.class,&quot;sink/payment1&quot;);
	...
	@GetMapping(value =&quot;/send2Payment&quot;)
    public BizMessage&lt;JSONObject&gt; send2Payment(String message) throws BizException {
        JSONObject jsonObject = new JSONObject();
        jsonObject.set(&quot;message&quot;,message);
        return this.payment1SinkInterface.call(jsonObject);
    }
}
</code></pre>
<p>开发者可以在适配层的PersonalController类中，通过personalAppInterface，把消息发送给缴费平台：</p>
<pre><code class="language-bash">$ curl http://localhost:9001/personal/send2Payment1\?message=hello|jq 

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;3c9d800b3c76480c9ae605d543709ea3&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631154087879,
  &quot;data&quot;: {
    &quot;message&quot;: &quot;hello&quot;
  }
}
</code></pre>
<h2 id="七项目实践应用服务对延迟服务的组装">七、项目实践：应用服务对延迟服务的组装</h2>
<h3 id="1-saf存储转发的实现">1. SAF存储转发的实现</h3>
<p>在领域层中，开发Payment2SinkService，根据tranMode交易模式，实现处理超时、处理失败和处理成功的各种异常情况：</p>
<pre><code class="language-java">@Service
public class Payment2SinkService implements JSONObjectSinkBeanInterface {
    @Autowired
    private TimeoutCmdExe timeoutCmdExe;
    @Autowired
    private TimeoutAndFailCmdExe timeoutAndFailCmdExe;
    @Autowired
    private TimeoutAndSuccessCmdExe timeoutAndSuccessCmdExe;
    @Autowired
    private SuccessCmdExe successCmdExe;

    @Override
    public JSONObject process(JSONObject jsonObject) throws BizException {
        log.info(&quot;传入消息:\n{}&quot;, jsonObject.toString());
        AbstractSinkBeanCmdExe sinkBeanCmdExe;
        String tranMode = (String)jsonObject.get(&quot;tranMode&quot;);
        switch (tranMode) {
            case &quot;timeout&quot;:
                // 收到交易后，永远返回超时
                return timeoutCmdExe.execute(jsonObject);
            case &quot;3timeout-fail&quot;:
                // 收到交易后，前3次返回超时，第4次返回失败码
                return timeoutAndFailCmdExe.execute(jsonObject);
            case &quot;3timeout-success&quot;:
                // 收到交易后，前3次返回超时，第4次成功返回原报文
                return timeoutAndSuccessCmdExe.execute(jsonObject);
            default:
                //其它情况,成功返回原报文
                return successCmdExe.execute(jsonObject);
        }
    }
}
</code></pre>
<p>注意，Payment2领域服务在封装时，涉及到多个接口调用，对每个接口采用命令执行器（Command Executor），这里是传入标准的JSONObject数据，所以所有的接口实现继承AbstractSinkBeanCmdExe类来实现：
<img src="1631778769217-1eb52b38-45bd-4dff-b4d2-aa09cb2acd00.png" alt="image.png">
在应用层中，在原有的PersonalAppInterface应用层接口、PersonalAppService服务类中，增加send2Payment2()、getCustomerAndSaf2Payment2()这2个方法接口和实现，通过personalAppDelayInterface延迟调用接口，实现对原有send2Payment2()方法的多次SAF调用：</p>
<pre><code class="language-java">@Service
public class PersonalAppService implements PersonalAppInterface {
    ...
        
    private BizMessageInterface payment2SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment2-sink&quot;);
    private PersonalAppInterface personalAppDelayInterface = IntegratorClientFactory
            .getDelayBizServiceClient(PersonalAppInterface.class,&quot;app/personal&quot;,
                    0,1000,2000,4000,8000,16000,32000);
	...
        
    @Override
    public BizMessage send2Payment2(String tranMode, String tranCode, Object message) throws BizException {
        JSONObject jsonObject = new JSONObject();
        jsonObject.set(&quot;tranCode&quot;,tranCode);
        jsonObject.set(&quot;tranMode&quot;,tranMode);
        jsonObject.set(&quot;message&quot;,message);
        return this.payment2SinkInterface.call(jsonObject);
    }

    @Override
    public Customer getCustomerAndSaf2Payment2(String tranMode,String customerId) throws BizException {
        Customer customer = this.customerSinkInterface.getCustomer(customerId);
        this.personalAppDelayInterface.send2Payment2(tranMode,&quot;send-customer&quot;, customer);
        return customer;
    }
    ...
}
</code></pre>
<p>传入交易模式为”timeout“（收到交易后，永远返回超时），这将导致发送7次，最后交易状态为失败：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomerAndSaf2Payment2&quot;,&quot;params&quot;:[&quot;timeout&quot;,&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;c1d2ffb7f0b44bf4b0cb7e13e5c0c0fa&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631274896174,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;sex&quot;: &quot;1&quot;,
      &quot;customerName&quot;: &quot;张三&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;age&quot;: 30
    }
  }
}

</code></pre>
<p>Payment2SinkApplication日志：</p>
<pre><code>2021-09-10 19:54:56.650  INFO 14993 --- [nio-8004-exec-3] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:54:56.651  INFO 14993 --- [nio-8004-exec-3] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:54:57.753  INFO 14993 --- [nio-8004-exec-4] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:54:57.754  INFO 14993 --- [nio-8004-exec-4] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:54:59.920  INFO 14993 --- [nio-8004-exec-5] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:54:59.920  INFO 14993 --- [nio-8004-exec-5] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:55:04.015  INFO 14993 --- [nio-8004-exec-6] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:55:04.015  INFO 14993 --- [nio-8004-exec-6] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:55:12.041  INFO 14993 --- [nio-8004-exec-7] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:55:12.042  INFO 14993 --- [nio-8004-exec-7] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:55:28.080  INFO 14993 --- [nio-8004-exec-8] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:55:28.080  INFO 14993 --- [nio-8004-exec-8] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:56:00.228  INFO 14993 --- [nio-8004-exec-9] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;timeout&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:56:00.228  INFO 14993 --- [nio-8004-exec-9] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!

</code></pre>
<p>传入交易码为”3timeout-fail“（收到交易后，前3次返回超时，第4次返回失败），这将导致发送4次，最后交易状态为失败：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomerAndSaf2Payment2&quot;,&quot;params&quot;:[&quot;3timeout-fail&quot;,&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;d3589b169d654a409c2f7d15f83f5113&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631275051123,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;sex&quot;: &quot;1&quot;,
      &quot;customerName&quot;: &quot;张三&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;age&quot;: 30
    }
  }
}

</code></pre>
<p>Payment2SinkApplication日志：</p>
<pre><code>2021-09-10 19:57:31.379  INFO 14993 --- [nio-8004-exec-1] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-fail&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:57:31.379  INFO 14993 --- [nio-8004-exec-1] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:57:32.647  INFO 14993 --- [nio-8004-exec-2] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-fail&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:57:32.647  INFO 14993 --- [nio-8004-exec-2] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:57:34.672  INFO 14993 --- [nio-8004-exec-3] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-fail&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:57:34.673  INFO 14993 --- [nio-8004-exec-3] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:57:38.733  INFO 14993 --- [nio-8004-exec-4] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-fail&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:57:38.733  INFO 14993 --- [nio-8004-exec-4] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回交易处理失败!
</code></pre>
<p>传入交易码为”3timeout-success“（收到交易后，前3次返回超时，第4次成功返回原报文），这将导致发送4次，最后交易状态为成功：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;getCustomerAndSaf2Payment2&quot;,&quot;params&quot;:[&quot;3timeout-success&quot;,&quot;001&quot;]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;75b76cf518164964bedf477ea488698c&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631275117934,
  &quot;data&quot;: {
    &quot;result&quot;: {
      &quot;sex&quot;: &quot;1&quot;,
      &quot;customerName&quot;: &quot;张三&quot;,
      &quot;customerId&quot;: &quot;001&quot;,
      &quot;age&quot;: 30
    }
  }
}
</code></pre>
<p>Payment2SinkApplication日志：</p>
<pre><code>2021-09-10 19:58:38.146  INFO 14993 --- [nio-8004-exec-5] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-success&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:58:38.146  INFO 14993 --- [nio-8004-exec-5] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:58:39.200  INFO 14993 --- [nio-8004-exec-6] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-success&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:58:39.200  INFO 14993 --- [nio-8004-exec-6] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:58:41.409  INFO 14993 --- [nio-8004-exec-7] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-success&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:58:41.409  INFO 14993 --- [nio-8004-exec-7] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回超时异常!
2021-09-10 19:58:45.539  INFO 14993 --- [nio-8004-exec-8] c.x.d.p.service.Payment2DomainService    : 传入消息:
{&quot;tranMode&quot;:&quot;3timeout-success&quot;,&quot;message&quot;:{&quot;sex&quot;:&quot;1&quot;,&quot;customerName&quot;:&quot;张三&quot;,&quot;customerId&quot;:&quot;001&quot;,&quot;age&quot;:30},&quot;tranCode&quot;:&quot;send-customer&quot;}
2021-09-10 19:58:45.539  INFO 14993 --- [nio-8004-exec-8] c.x.d.p.service.Payment2DomainService    : 交易:send-customer,返回交易成功!
</code></pre>
<h3 id="2-向前补偿的实现">2. 向前补偿的实现</h3>
<p>向前补偿机制是指当交易无应答时，系统会对原交易进行查询，如查询超时会重试多次。如原交易成功则继续后续交易，如原交易失败则对前续交易进行交易补偿，向前补偿一般是针对第三方接入方无法提供补偿交易时的解决方案。
在金融领域，这类交易补偿动作常被称为“冲正”。
在应用层中，在原有的PersonalAppInterface应用层接口、PersonalAppService服务类中，增加payoutForward()、payoutForwardCompensate()这2个方法接口和实现，通过personalAppDelayInterface延迟调用接口，实现对原有payoutForwardCompensate()方法的多次重复延迟调用：</p>
<pre><code class="language-java">@Service
public class PersonalAppService implements PersonalAppInterface {
    private AccountSinkInterface accountSinkInterface = IntegratorClientFactory
            .getSinkClient(AccountSinkInterface.class,&quot;account-sink&quot;);
    private CustomerSinkInterface customerSinkInterface = IntegratorClientFactory
            .getSinkClient(CustomerSinkInterface.class,&quot;customer-sink&quot;);
    private BizMessageInterface payment1SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment1-sink&quot;);
    private BizMessageInterface payment2SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment2-sink&quot;);
    private PersonalAppInterface personalAppDelayInterface = IntegratorClientFactory
            .getDelayBizServiceClient(PersonalAppInterface.class,&quot;app/personal&quot;,
                    0,1000,2000,4000,8000,16000,32000);
    
    ......
        
	@Override
    public void payoutForward(String tranMode,String accountId, long amount) throws BizException {
        log.info(&quot;account出金:{},{}&quot;,accountId,amount);
        this.accountDomainInterface.payout(accountId,amount);
        JSONObject jsonObject = new JSONObject();
        jsonObject.set(&quot;tranCode&quot;,&quot;pay&quot;);
        jsonObject.set(&quot;tranMode&quot;,tranMode);
        jsonObject.set(&quot;accountId&quot;,accountId);
        jsonObject.set(&quot;tranAmount&quot;,amount);
        BizMessage&lt;JSONObject&gt; bizMessage = null;
        try {
            log.info(&quot;payment缴费...&quot;);
            bizMessage = this.payment2SinkInterface.call(jsonObject);
        } catch (BizException e) {
            if (e.isTimeOutException()) {
                log.info(&quot;payment交易超时,开始payout补偿...&quot;);
                this.personalAppDelayInterface.payoutForwardCompensate(jsonObject);
                return;
            }
            else {
                throw e;
            }
        }
        log.info(&quot;payment缴费成功!&quot;);
        log.info(&quot;payout成功!&quot;);
    }

    @Override
    public void payoutForwardCompensate(JSONObject jsonObject)  throws BizException{
        jsonObject.set(&quot;tranCode&quot;,&quot;pay-query&quot;);
        BizMessage&lt;JSONObject&gt; bizMessage = null;
        try {
            log.info(&quot;payment查询缴费订单...&quot;);
            bizMessage = this.payment2SinkInterface.call(jsonObject);
        } catch (BizException e) {
            if (e.isTimeOutException()) {
                log.info(&quot;payment交易超时...&quot;);
                throw e;
            }
            else {
                log.info(&quot;payment查询缴费订单返回错误（表示对方订单没执行）...&quot;);
                String accountId = (String)jsonObject.get(&quot;accountId&quot;);
                long amount = (Integer) jsonObject.get(&quot;tranAmount&quot;);
                log.info(&quot;account出金补偿:{},{}&quot;,accountId,amount);
                this.accountDomainInterface.payoutCompensation(accountId,amount);
                return;
            }
        }
        log.info(&quot;payment查询缴费订单成功（表示对方订单已执行）&quot;);
        log.info(&quot;payout成功!&quot;);
    }
</code></pre>
<p>传入交易模式为”3timeout-success“（收到订单交易后，前3次返回超时，第4次成功返回模拟订单已执行），这将导致发送4次，最后交易状态为成功：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;payoutForward&quot;,&quot;params&quot;:[&quot;3timeout-success&quot;,&quot;0001&quot;,1]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;e0127a25e2514da682ad77042917087a&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631275840559,
  &quot;data&quot;: {}
}
</code></pre>
<p>XbankAppApplication日志：</p>
<pre><code>[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:40.560 INFO 16503 [11034350FE38437BB459F1E8DC6CCE17] [http-nio-8888-exec-5] c.xbank.app.service.PersonalAppService   account出金:0001,1
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:40.822 INFO 16503 [11034350FE38437BB459F1E8DC6CCE17] [http-nio-8888-exec-5] c.xbank.app.service.PersonalAppService   payment缴费...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:40.831 INFO 16503 [11034350FE38437BB459F1E8DC6CCE17] [http-nio-8888-exec-5] c.xbank.app.service.PersonalAppService   payment交易超时,开始payout补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:42.086 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:42.095 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:43.268 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:43.277 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   payment交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:45.296 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:45.306 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] c.xbank.app.service.PersonalAppService   payment查询缴费订单成功（表示对方订单已执行）
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:10:45.306 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] c.xbank.app.service.PersonalAppService   payout成功!
</code></pre>
<p>传入交易模式为”3timeout-success“（收到订单交易后，前3次返回超时，第4次成功返回模拟订单已执行），这将导致发送4次，最后交易状态为成功：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;payoutForward&quot;,&quot;params&quot;:[&quot;3timeout-fail&quot;,&quot;0001&quot;,1]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;a04163bf05484fa28071650a085d4124&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631275997342,
  &quot;data&quot;: {}
}

</code></pre>
<p>XbankAppApplication日志：</p>
<pre><code>[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:17.342 INFO 16503 [5E5951618A27430684C5552E1F782D8B] [http-nio-8888-exec-7] c.xbank.app.service.PersonalAppService   account出金:0001,1
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:17.568 INFO 16503 [5E5951618A27430684C5552E1F782D8B] [http-nio-8888-exec-7] c.xbank.app.service.PersonalAppService   payment缴费...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:17.579 INFO 16503 [5E5951618A27430684C5552E1F782D8B] [http-nio-8888-exec-7] c.xbank.app.service.PersonalAppService   payment交易超时,开始payout补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:17.775 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-5] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:17.788 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-5] c.xbank.app.service.PersonalAppService   payment交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:18.827 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:18.836 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:20.890 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment查询缴费订单...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:20.900 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment查询缴费订单返回错误（表示对方订单没执行）...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:13:20.901 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   account出金补偿:0001,1
</code></pre>
<h3 id="3-向后补偿的实现">3. 向后补偿的实现</h3>
<p>向后补偿机制是指当交易无应答时，系统会对原交易发起多次交易补偿重试，如补偿交易成功则对前续交易进行补偿。
在应用层中，在原有的PersonalAppInterface应用层接口、PersonalAppService服务类中，增加payoutBackward()、payoutBackwardCompensate()这2个方法接口和实现，通过personalAppDelayInterface延迟调用接口，实现对原有payoutForwardCompensate()方法的多次重复延迟调用：</p>
<pre><code class="language-java">@Service
public class PersonalAppService implements PersonalAppInterface {
    private AccountSinkInterface accountSinkInterface = IntegratorClientFactory
            .getSinkClient(AccountSinkInterface.class,&quot;account-sink&quot;);
    private CustomerSinkInterface customerSinkInterface = IntegratorClientFactory
            .getSinkClient(CustomerSinkInterface.class,&quot;customer-sink&quot;);
    private BizMessageInterface payment1SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment1-sink&quot;);
    private BizMessageInterface payment2SinkInterface = IntegratorClientFactory
            .getSinkClient(BizMessageInterface.class,&quot;payment2-sink&quot;);
    private PersonalAppInterface personalAppDelayInterface = IntegratorClientFactory
            .getDelayBizServiceClient(PersonalAppInterface.class,&quot;app/personal&quot;,
                    0,1000,2000,4000,8000,16000,32000);
    
    ......
        
	@Override
    public void payoutBackward(String tranMode, String accountId, long amount) throws BizException {
        log.info(&quot;account出金:{},{}&quot;,accountId,amount);
        this.accountDomainInterface.payout(accountId,amount);
        JSONObject jsonObject = new JSONObject();
        jsonObject.set(&quot;tranCode&quot;,&quot;pay&quot;);
        jsonObject.set(&quot;tranMode&quot;,tranMode);
        jsonObject.set(&quot;accountId&quot;,accountId);
        jsonObject.set(&quot;tranAmount&quot;,amount);
        BizMessage&lt;JSONObject&gt; bizMessage = null;
        try {
            log.info(&quot;payment缴费...&quot;);
            bizMessage = this.payment2SinkInterface.call(jsonObject);
        } catch (BizException e) {
            if (e.isTimeOutException()) {
                log.info(&quot;payment交易超时,开始payout冲正...&quot;);
                this.personalAppDelayInterface.payoutBackwardCompensate(jsonObject);
                return;
            }
            else {
                log.info(&quot;payment缴费交易返回错误&quot;);
                log.info(&quot;account出金补偿:{},{}&quot;,accountId,amount);
                this.accountDomainInterface.payoutCompensation(accountId,amount);
                log.info(&quot;payout交易补偿成功！&quot;);
                return;
            }
        }
        log.info(&quot;payment缴费成功&quot;);
        log.info(&quot;payout成功!&quot;);
    }

    @Override
    public void payoutBackwardCompensate(JSONObject jsonObject) throws BizException {
        jsonObject.set(&quot;tranCode&quot;,&quot;pay-reversal&quot;);
        BizMessage&lt;JSONObject&gt; bizMessage;
        try {
            log.info(&quot;payment缴费补偿...&quot;);
            bizMessage = this.payment2SinkInterface.call(jsonObject);
            log.info(&quot;payment缴费补偿成功&quot;);
        } catch (BizException e) {
            if (e.isTimeOutException()) {
                log.info(&quot;payment缴费补偿交易超时...&quot;);
                throw e;
            }
            log.info(&quot;payment缴费补偿交易失败,需要人工干预调整!&quot;);
            return;
        }
        String accountId = (String)jsonObject.get(&quot;accountId&quot;);
        long amount = (Integer)jsonObject.get(&quot;tranAmount&quot;);
        log.info(&quot;account出金补偿:{},{}&quot;,accountId,amount);
        this.accountDomainInterface.payoutCompensation(accountId,amount);
        log.info(&quot;payout补偿成功！&quot;);
    }
</code></pre>
<p>传入交易模式为”3timeout-success“（收到订单交易后，前3次返回补偿交易超时，第4次成功返回补偿交易执行成功），这将导致发送4次，最后交易状态为成功：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;payoutBackward&quot;,&quot;params&quot;:[&quot;3timeout-success&quot;,&quot;0001&quot;,1]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;26c58fe44b3f4ceba462762494fa5981&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631276405513,
  &quot;data&quot;: {}
}
</code></pre>
<p>XbankAppApplication日志：</p>
<pre><code class="language-java">[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:05.513 INFO 16503 [84936F44451449C5A92183EF93C3690C] [http-nio-8888-exec-2] c.xbank.app.service.PersonalAppService   account出金:0001,1
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:05.952 INFO 16503 [84936F44451449C5A92183EF93C3690C] [http-nio-8888-exec-2] c.xbank.app.service.PersonalAppService   payment缴费...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:05.961 INFO 16503 [84936F44451449C5A92183EF93C3690C] [http-nio-8888-exec-2] c.xbank.app.service.PersonalAppService   payment交易超时,开始payout冲正...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:06.396 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:06.405 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment缴费补偿交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:07.468 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:07.475 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-4] c.xbank.app.service.PersonalAppService   payment缴费补偿交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:09.560 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:09.570 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   payment缴费补偿成功
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:09.571 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   account出金补偿:0001,1
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:20:09.726 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-3] c.xbank.app.service.PersonalAppService   payout补偿成功！
</code></pre>
<p>传入交易模式为”3timeout-fail“（收到订单交易后，前3次返回超时，第4次成功返回模拟补偿交易失败），这将导致发送4次，最后交易状态为失败：</p>
<pre><code class="language-bash">$ curl -H &quot;Content-Type:application/json&quot; -H &quot;Biz-Service-Id:app/personal&quot; -X POST --data '{&quot;methodName&quot;:&quot;payoutBackward&quot;,&quot;params&quot;:[&quot;3timeout-fail&quot;,&quot;0001&quot;,1]}' http://localhost:8888/api|jq

{
  &quot;code&quot;: 0,
  &quot;message&quot;: &quot;success&quot;,
  &quot;extMessage&quot;: null,
  &quot;traceId&quot;: &quot;40aed8f06bba436ba67ff93e769d5a33&quot;,
  &quot;parentTraceId&quot;: null,
  &quot;timestamp&quot;: 1631276555599,
  &quot;data&quot;: {}
}
</code></pre>
<p>XbankAppApplication日志：</p>
<pre><code>[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:35.599 INFO 16503 [B54A535614A64492A7A00D987F12B529] [http-nio-8888-exec-4] c.xbank.app.service.PersonalAppService   account出金:0001,1
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:35.760 INFO 16503 [B54A535614A64492A7A00D987F12B529] [http-nio-8888-exec-4] c.xbank.app.service.PersonalAppService   payment缴费...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:35.767 INFO 16503 [B54A535614A64492A7A00D987F12B529] [http-nio-8888-exec-4] c.xbank.app.service.PersonalAppService   payment交易超时,开始payout冲正...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:35.979 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:35.993 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-2] c.xbank.app.service.PersonalAppService   payment缴费补偿交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:37.073 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-5] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:37.083 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-5] c.xbank.app.service.PersonalAppService   payment缴费补偿交易超时...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:39.111 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment缴费补偿...
[bizsip-integrator:192.169.1.101:8888] 2021-09-10 20:22:39.121 INFO 16503 [] [org.springframework.amqp.rabbit.RabbitListenerEndpointContainer#0-1] c.xbank.app.service.PersonalAppService   payment缴费补偿交易失败,需要人工干预调整!
</code></pre>
<h2 id="八总结">八、总结</h2>
<h3 id="1-sink服务领域层服务">1. Sink服务（领域层服务）</h3>
<ul>
<li>sink-bean类sink服务
<ul>
<li>sink接口为BizMessage<JSONObject>类型；</li>
<li>基于<SinkBeanInterface>或<JSONObjectSinkBeanInterface>接口开发服务类，实现process()方法，2个接口区别在于出入参数的类型，前1个是byte[]类型，后1个是JSONObject类型；</li>
<li>在sink.yml中配置”sink-bean“类型的connector，服务类支持JavaBean和SpringBean二种挂接方式；</li>
<li>在sink.yml中支持多种convert，传入process()方法的参数为经过convert转换后的消息。</li>
</ul>
</li>
<li>bean类sink服务
<ul>
<li>sink接口为BizMessage<JSONObject>类型，JSONObject消息体中包括：className（可选）、methodName（可选）、params（必选），params为JSONArray类型；</li>
<li>可自由开发服务类；</li>
<li>在sink.yml中配置”bean“类型的connector，服务类支持JavaBean和SpringBean二种挂接方式；</li>
<li>在sink.yml中convert只支持simple-json类型（后期可能会取消对于bean类sink服务的convert配置）。</li>
</ul>
</li>
</ul>
<h3 id="2-biz-service聚合服务应用层服务">2. Biz-Service聚合服务（应用层服务）</h3>
<p>integrator接口为带”Biz-Service-Id“header头、以POST方式提交JSON数据，返回为BizMessage<JSONObject>类型的JSON串。
在integrator-bean-service、bean-service类聚合服务开发服务类中，可以用IntegratorClientFactory.getSinkClient()和IntegratorClientFactory.getDelayBizServiceClient()，分别获取sink接口访问和延迟Biz-Service聚合服务接口访问的client API接口。
对sink-bean类sink服务，sink接口为BizMessage<JSONObject>类型，应采用<BizMessageInterface>接口，统一调用call()方法。</p>
<ul>
<li>integrator-bean-service类聚合服务
<ul>
<li>请求提交为JSON数据；</li>
<li>基于<IntegratorBeanInterface>接口开发服务类，实现doBizService()方法；</li>
<li>在service.yml中配置”integrator-bean-service“类型的聚合服务，服务类目前只支持JavaBean挂接方式。</li>
</ul>
</li>
<li>bean-service类聚合服务
<ul>
<li>请求提交为JSON数据，JSON数据中包括：methodName（必选）、params（必选），params为JSONArray类型；</li>
<li>可自由开发服务类；</li>
<li>在service.yml中配置”bean-service“类型的聚合服务，服务类目前只支持SpringBean挂接方式。</li>
</ul>
</li>
<li>sink-service类聚合服务
<ul>
<li>请求提交为JSON数据，JSON数据根据后端sink服务接口来定；</li>
<li>无需开发代码；</li>
<li>在service.yml中配置”sink-service“类型的聚合服务，并配置关联到后端的sink端口。</li>
</ul>
</li>
<li>script类聚合服务
<ul>
<li>请求提交为JSON数据即可，在脚本中调用sink前，应按要求转换成sink约定的JSON数据格式；</li>
<li>无需开发Java代码，但需配置聚合服务脚本；</li>
<li>在config/service目录中配置脚本文件，无需在service.yml中配置。</li>
</ul>
</li>
</ul>
<h3 id="3-适配层服务">3. 适配层服务</h3>
<ul>
<li>采用Biz-SIP自带OpenAPI接口
<ul>
<li>Integrator接口为Biz-SIP平台的OpenAPI接口，可以按需对外开放访问。</li>
</ul>
</li>
<li>定制适配层接入模块
<ul>
<li>引入Souce类，可以根据消息格式转换的定制，自动进行消息格式转换和适配；</li>
<li>通过SourceClientFactory.getBizServiceClient()，获取Biz-Service聚合服务访问接口（具体请参见<a href="#lazZY">链接</a>）。</li>
</ul>
</li>
</ul>
<h2 id="附录1biz-sip运行机制图">附录1：Biz-SIP运行机制图</h2>
<p><img src="1631863592446-fa064970-8fc9-4d81-b1dc-8b601c639846.png" alt="image.png"></p>
<h2 id="附录2ddd各层功能定位与粒度划分">附录2：DDD各层功能定位与粒度划分</h2>
<table>
<thead>
<tr>
<th>层级</th>
<th>功能定位</th>
<th>粒度划分</th>
</tr>
</thead>
<tbody>
<tr>
<td>适配层</td>
<td>渠道接入相关的加解密、验签；<br>渠道接入通讯连接的对接；<br>渠道消息格式的转换；<br>OpenAPI的接入；</td>
<td>按接入渠道进行划分；<br>渠道入口和出口，可能会拆分，一般渠道入口在适配层，出口由领域层对接；</td>
</tr>
<tr>
<td>应用层</td>
<td>统一应用层消息校验；<br>领域层服务的组装和编排；</td>
<td>按业务、按系统进行拆分，涉及到1个以上领域服务；</td>
</tr>
<tr>
<td>领域层</td>
<td>交易处理；<br>第三方对接，包括安全（加解密、验签）、通讯、消息格式的转换；</td>
<td>交易系统，按业务划分；<br>对接第三方，按渠道；<br>按数据库划分；</td>
</tr>
<tr>
<td>基础设施层</td>
<td>数据库DAO；<br>HSM安全</td>
<td></td>
</tr>
</tbody>
</table>
          </div>

          



          
          
          <div class="article-widget">
            
<div class="post-nav">
  
  
  
  <div class="post-nav-item">
    <div class="meta-nav">上一页</div>
    <a href="/doc/extend/" rel="next">扩展开发</a>
  </div>
  
  
</div>

          </div>
          
        </div>

        <div class="body-footer">
          <p>最近更新于 Sep 24, 2021</p>

          



          




          




        </div>

      </article>

      <footer class="site-footer">

  

  

  
  <p class="powered-by">
    © 2020-2021 BIZMDA.com版权所有 <a href="http://beian.miit.gov.cn">沪ICP备2021002172号</a>
  </p>
  

  
  






  <p class="powered-by">
    
    
    
      
      
      
      
      
      
      由<a href="https://wowchemy.com/?utm_campaign=poweredby" target="_blank" rel="noopener">Wowchemy</a>支持发布——免费<a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">开源</a>网站，为创作者赋能。
    
  </p>
</footer>


    </main>
  </div>
</div>

  </div>

  <div class="page-footer">
    
    
  </div>

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">引用</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> 复制
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> 下载
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      

      
      

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
      

    

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/4.2.2/anchor.min.js" integrity="sha512-I7w3ZdSFzw5j3jU3ZkNikBNeIrl3i+hEuEdwNmqUJvwNcaBUNcijnP2gd9DtGlgVYDplfjGoD8vTNsID+lCjqg==" crossorigin="anonymous"></script>
    <script>
      anchors.add();
    </script>
    

    
    
    
      
      <script id="search-hit-fuse-template" type="text/x-template">
        <div class="search-hit" id="summary-{{key}}">
          <div class="search-hit-content">
            <div class="search-hit-name">
              <a href="{{relpermalink}}">{{title}}</a>
              <div class="article-metadata search-hit-type">{{type}}</div>
              <p class="search-hit-description">{{snippet}}</p>
            </div>
          </div>
        </div>
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
      
    

    
    

    
    
    
    

    
    <script src="/js/bootstrap.bundle.min.6aed84840afc03ab4d5750157f69c120.js"></script>

    
    
      
      
      
      
      
      
      
    

    
    
    
    
    
    
    
    
      
      
    
    
    <script src="/zh/js/wowchemy.min.c01dc0f474cb5aa17a63e06eb00111fe.js"></script>

    






</body>
</html>
